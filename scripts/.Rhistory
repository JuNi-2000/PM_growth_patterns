source("C:/Users/Julian/Desktop/DSP_analysis/DSP.R")
ggplot(de_results_BvT, aes(AveExpr, logFC, col = DE)) +
geom_point(shape = 1, size = 1) +
geom_text_repel(data = de_genes_toptable_BvT %>%
mutate(DE = ifelse(logFC > 0 & adj.P.Val <0.05, "UP",
ifelse(logFC <0 & adj.P.Val<0.05, "DOWN", "NOT DE"))) %>%
rownames_to_column(), aes(label = rowname)) +
theme_bw() +
xlab("Average log-expression") +
ylab("Log-fold-change") +
ggtitle("B cell zone vs. T cell zone in Lymph node (limma-voom)") +
scale_color_manual(values = c("blue","gray","red")) +
theme(text = element_text(size=15))
de_results_BvT <- mutate(de_results_BvT, DE = ifelse(logFC > 0 & adj.P.Val <0.05, "UP", ifelse(logFC <0 & adj.P.Val<0.05, "DOWN", "NOT DE")))
de_results_BvT <- topTable(efit, coef = 1, sort.by = "P", n = Inf)
# Apply the threshold to the data
spatial_experiment <- spatial_experiment[, qc]
# Apply the threshold to the data
spatial_experiment <- spatial_experiment[, qc]
library(tidyverse)
library(readxl)
library(standR)
library(SpatialExperiment)
library(ggplot2)
library(ggalluvial)
library(edgeR)
library(limma)
######################## SETTING UP WORKSPACE ########################
# Setting working directory
setwd("C:/Users/Julian/Desktop/DSP_analysis")
# Load data
target_count_matrix <- as.data.frame(read_excel("./DSP_22_09_meso_RawData.xlsx", sheet=3))
sample_anno_file <- as.data.frame(read_excel("./DSP_22_09_meso_RawData.xlsx", sheet=1))
feature_anno_file <- as.data.frame(read_excel("./DSP_22_09_meso_RawData.xlsx", sheet=2))
morphologies <- as.data.frame(read_excel("./Meso_morphology_TMA_22_09.xlsx"))
metadata <- read_delim("./metadata_merged_anon.tsv", delim = "\t")
############### DATA CLEANING ####################
# Creating clean data structure for morphology file
names(morphologies) <- c("SlideName", "core.x", "core.y", "growthPattern", "secondaryGrowthPattern")
# Make sure the growth patterns are numeric entries only
morphologies$growthPattern <- as.numeric(morphologies$growthPattern)
morphologies$secondaryGrowthPattern <- as.numeric(morphologies$secondaryGrowthPattern)
# Remove NA entries for primary growth patterns
morphologies <- drop_na(morphologies, c("growthPattern"))
# Fill NAs in secondary growth patterns with 0 to prevent working with NA entries
morphologies$secondaryGrowthPattern[is.na(morphologies$secondaryGrowthPattern)] <- 0
# Create boolean entries for growth patterns
morphologies <- morphologies %>%
mutate(solid = growthPattern == 1 | secondaryGrowthPattern == 1,
papillary = growthPattern == 2 | secondaryGrowthPattern == 2,
glandular = growthPattern == 3 | secondaryGrowthPattern == 3,
other = growthPattern == 4 | secondaryGrowthPattern == 4)
# Merging morphologies with sample_anno file
sample_anno_file_merged <- merge(sample_anno_file, morphologies, by = c("core.x", "core.y", "SlideName"), all = TRUE)
# Merging pre / post chemo and donor block ID information with sample anno file
pre_post_info <- metadata[, c("SlideName", "core.x", "core.y", "SegmentLabel", "Pre_Post", "PID_anon")]
sample_anno_file_merged <- merge(sample_anno_file_merged, pre_post_info, by = c("core.x", "core.y", "SlideName", "SegmentLabel"), all= TRUE)
# Create the spatial experiment object
spatial_experiment <- readGeoMx(target_count_matrix,
sample_anno_file_merged,
feature_anno_file)
# remove NA entries in the growth patterns
spatial_experiment <- spatial_experiment[, !is.na(colData(spatial_experiment)$growthPattern)]
?SpatialExperiment
?saveRDS
?`saveRDS,SummarizedExperiment-method`
?geomxBatchCorrection
colData(spa_experiment_TMM)
colData(spatial_experiment)
colData(spatial_experiment)$counts
?geomxBatchCorrection
saveRDS(spatial_experiment, file = "my_spatial_experiment.rds")
